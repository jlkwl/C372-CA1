<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shopping</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { background: #f4f4f4; }

        .category-bar button.active {
            background: #0066cc;
            color: white !important;
        }

        .product-card {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            background: white;
            transition: transform .2s;
        }

        .product-card:hover {
            transform: scale(1.03);
        }

        .product-card img {
            width: 100%;
            height: 160px;
            object-fit: contain;
            background: white;
        }

        .out-of-stock {
            opacity: 0.6;
        }

        #suggestions {
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>

<body>

<%- include('partials/navbar'); %>

<div class="container mt-4">

    <!-- ðŸ” SEARCH BAR + Suggestions -->
    <form method="GET" action="/shopping" class="position-relative mb-4">
        <input id="searchBox"
               class="form-control"
               type="text"
               placeholder="Search products..."
               name="search"
               autocomplete="off"
               value="<%= search %>">

        <button class="btn btn-primary position-absolute top-0 end-0" style="height:100%;">
            Search
        </button>

        <ul id="suggestions" 
            class="list-group position-absolute w-100" 
            style="z-index: 99; display: none;"></ul>
    </form>

    <!-- ðŸ§­ CATEGORY FILTER -->
    <div class="d-flex gap-2 mb-4 category-bar">
        <% const categories = ["All", "Fruits", "Vegetables", "Dairy", "Bakery"]; %>

        <% categories.forEach(cat => { %>
            <button class="btn btn-light <%= category === cat ? 'active' : '' %>"
                onclick="window.location='/shopping?category=<%= cat %>&search=<%= search %>'">
                <%= cat %>
            </button>
        <% }); %>
    </div>

    <!-- PRODUCT GRID -->
    <div class="row g-4">
        <% products.forEach(p => { %>

            <% const outStock = p.quantity <= 0; %>

            <div class="col-md-3">
                <div class="product-card p-3 <%= outStock ? 'out-of-stock' : '' %>">
                    <img src="/images/<%= p.image %>" alt="<%= p.productName %>">

                    <h5 class="mt-2"><%= p.productName %></h5>

                    <span class="badge <%= outStock ? 'bg-danger' : 'bg-success' %>">
                        <%= outStock ? 'Out of stock' : 'In stock' %>
                    </span>

                    <p class="mt-2">$<%= p.price.toFixed(2) %></p>

                    <% if (!outStock) { %>
                        <form action="/add-to-cart/<%= p.id %>" method="POST">
                            <select name="quantity" class="form-select mb-2">
                                <% for (let q = 1; q <= 10; q++) { %>
                                    <option value="<%= q %>"><%= q %></option>
                                <% } %>
                            </select>
                            <button class="btn btn-primary w-100">Add to Cart</button>
                        </form>
                    <% } else { %>
                        <button class="btn btn-secondary w-100" disabled>Unavailable</button>
                    <% } %>
                </div>
            </div>
        <% }) %>
    </div>
</div>

<script>
// LIVE SEARCH DROPDOWN
const box = document.getElementById("searchBox");
const sug = document.getElementById("suggestions");

box.addEventListener("input", () => {
    const term = box.value.trim();

    if (term.length === 0) {
        sug.style.display = "none";
        return;
    }

    fetch(`/search-suggestions?term=${term}`)
        .then(r => r.json())
        .then(list => {
            sug.innerHTML = "";

            if (list.length === 0) {
                sug.style.display = "none";
                return;
            }

            list.forEach(item => {
                const li = document.createElement("li");
                li.className = "list-group-item";
                li.style.cursor = "pointer";
                li.innerText = item;

                li.onclick = () => {
                    box.value = item;
                    sug.style.display = "none";
                };

                sug.appendChild(li);
            });

            sug.style.display = "block";
        });
});

document.addEventListener("click", (e) => {
    if (!box.contains(e.target)) sug.style.display = "none";
});
</script>

</body>
</html>