<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Checkout</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/style.css" />

  <style>
    body { background: #f7f7f7; font-family: Arial, Helvetica, sans-serif; }
    .wrap {
      max-width: 1000px; margin: 40px auto; padding: 25px;
      background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }
    .title { font-size: 34px; font-weight: 800; margin-bottom: 5px; }
    .sub { color: #666; margin-bottom: 20px; }
    .box { border: 1px solid #e5e5e5; border-radius: 12px; padding: 18px; }
    .total { font-size: 18px; font-weight: 800; text-align: right; }
    .pay-panel { border-radius: 12px; padding: 16px; border: 1px solid #e5e5e5; }
    #paypalPanel { background: #fff7db; border-color: #f1d48a; }
    #bankPanel { background: #f2f2f2; border-color: #e0e0e0; }
    .btn-back { background: #6c757d; border: none; }
    .btn-back:hover { background: #5a6268; }
    .status { margin-top: 10px; color: #555; font-size: 14px; }
  </style>
</head>

<body>
  <%- include('partials/header', { user: user }) %>

  <div class="wrap">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
      <div>
        <div class="title">Supermarket Invoice</div>
        <div class="sub">Review your items and choose a payment method.</div>
      </div>
      <div class="text-end">
        <div><strong>Customer:</strong> <%= user?.email || "-" %></div>
        <div><strong>Date:</strong> <%= new Date().toLocaleDateString() %></div>
      </div>
    </div>

    <div class="box mb-4">
      <table class="table align-middle mb-2">
        <thead>
          <tr>
            <th>Product</th>
            <th class="text-end">Unit Price</th>
            <th class="text-end">Qty</th>
            <th class="text-end">Line Total</th>
          </tr>
        </thead>
        <tbody>
          <% cart.forEach(item => { %>
            <tr>
              <td><%= item.productName %></td>
              <td class="text-end">$<%= Number(item.price).toFixed(2) %></td>
              <td class="text-end"><%= Number(item.quantity) %></td>
              <td class="text-end">$<%= (Number(item.price) * Number(item.quantity)).toFixed(2) %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>

      <div class="total">
        Total: $<%= Number(total).toFixed(2) %>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label"><strong>Payment Method</strong></label>
        <select id="paymentMethod" class="form-select">
          <option value="paypal" selected>PayPal</option>
          <option value="bank">Bank Transfer</option>
        </select>
        <div class="sub mt-2">Choose a method to display the payment option.</div>

        <a href="/cart" class="btn btn-back text-white w-100 mt-3">Back to Cart</a>
      </div>

      <div class="col-md-8">
        <div id="paypalPanel" class="pay-panel">
          <h5 class="mb-1"><strong>Pay with PayPal</strong></h5>
          <div class="sub mb-3">Sandbox testing uses your PayPal sandbox buyer account.</div>
          <div id="paypal-button-container"></div>
          <div id="paypalStatus" class="status"></div>
        </div>

        <div id="bankPanel" class="pay-panel" style="display:none;">
          <h5 class="mb-1"><strong>Bank Transfer</strong></h5>
          <div class="sub">For demo: show your bank instructions here.</div>
          <div class="mt-2">
            Transfer to: <strong>Supermarket Pte Ltd</strong><br/>
            Bank: <strong>DBS</strong> | Account: <strong>123-456-789</strong><br/>
            Reference: <strong>INV-<%= invoiceNo %></strong>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… PayPal SDK (needs paypalClientId passed from server) -->
  <script src="https://www.paypal.com/sdk/js?client-id=<%= paypalClientId %>&currency=SGD"></script>

  <script>
    const paymentMethodEl = document.getElementById("paymentMethod");
    const paypalPanel = document.getElementById("paypalPanel");
    const bankPanel = document.getElementById("bankPanel");
    const paypalStatus = document.getElementById("paypalStatus");

    function switchMethod() {
      const m = paymentMethodEl.value;
      paypalPanel.style.display = (m === "paypal") ? "block" : "none";
      bankPanel.style.display = (m === "bank") ? "block" : "none";
    }
    paymentMethodEl.addEventListener("change", switchMethod);
    switchMethod();

    // Safe numeric total from server
    const total = <%- JSON.stringify(Number(total).toFixed(2)) %>;

    paypal.Buttons({
      createOrder: async function () {
        paypalStatus.textContent = "Creating PayPal order...";
        const res = await fetch("/api/paypal/create-order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ total })
        });

        const data = await res.json();
        if (!res.ok) {
          console.error("create-order failed:", data);
          throw new Error(data.message || data.error || "Create order failed");
        }
        return data.id;
      },

      onApprove: async function (data) {
        paypalStatus.textContent = "Capturing payment...";
        const res = await fetch("/api/paypal/capture-order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ orderID: data.orderID })
        });

        const result = await res.json();
        if (!res.ok) {
          console.error("capture-order failed:", result);
          alert("PayPal capture failed. Please try again.");
          return;
        }

        // Redirect to success page
        window.location.href = "/payment-success";
      },

      onError: function (err) {
        console.error("PayPal error:", err);
        alert("PayPal error. Please try again.");
      }
    }).render("#paypal-button-container");
  </script>
</body>
</html>
