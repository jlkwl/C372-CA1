<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Checkout</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body{
      background:#f4f6f9;
      font-family: Arial, Helvetica, sans-serif;
    }
    .page-wrap{
      max-width: 1100px;
      margin: 40px auto;
      padding: 0 16px;
    }
    .title{
      font-size: 40px;
      font-weight: 800;
      margin-bottom: 18px;
      color:#1f2a37;
    }
    .card-soft{
      background:#fff;
      border-radius: 14px;
      box-shadow: 0 8px 28px rgba(0,0,0,0.08);
      padding: 22px;
      margin-bottom: 18px;
    }
    .subtle{
      color:#6b7280;
      font-size: 14px;
    }
    .invoice-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 20px;
      margin-bottom: 10px;
    }
    .invoice-header b{
      color:#111827;
    }
    table td, table th{
      vertical-align: middle;
    }
    .total-row{
      text-align:right;
      font-weight: 800;
      font-size: 20px;
      color:#111827;
    }
    .pay-panel{
      border: 1px solid #e5e7eb;
      background:#fafafa;
      border-radius: 12px;
      padding: 16px;
    }
    .paypal-box{
      background:#fff7d6;
      border: 1px solid #f3d57b;
      border-radius: 12px;
      padding: 14px;
    }

    /* ✅ NETS styling */
    .nets-box{
      background:#eafff3;
      border: 1px solid #98e3b8;
      border-radius: 12px;
      padding: 14px;
    }
    .btn-nets{
      background:#3bb77e;
      border:none;
      color:#fff;
      padding:10px 18px;
      border-radius: 10px;
    }
    .btn-nets:hover{ background:#2ea06b; }

    .btn-back{
      background:#6b7280;
      border:none;
      color:#fff;
      padding:10px 18px;
      border-radius: 10px;
      text-decoration:none;
      display:inline-block;
    }
    .btn-back:hover{ background:#4b5563; color:#fff; }
  </style>
</head>

<body>
  <%- include('partials/header', { user: user }) %>

  <div class="page-wrap">
    <div class="title">Supermarket Invoice</div>

    <div class="card-soft">
      <div class="invoice-header">
        <div>
          <div><b>Customer:</b> <%= user?.email || "Customer" %></div>
          <div class="subtle">Review your items and choose a payment method.</div>
        </div>
        <div><b>Date:</b> <%= new Date().toLocaleDateString() %></div>
      </div>

      <div class="table-responsive">
        <table class="table table-striped align-middle">
          <thead>
            <tr>
              <th>Product</th>
              <th class="text-end">Unit Price</th>
              <th class="text-end">Qty</th>
              <th class="text-end">Line Total</th>
            </tr>
          </thead>
          <tbody>
            <% (cart || []).forEach(function(item){ %>
              <tr>
                <td><%= item.productName %></td>
                <td class="text-end">$<%= Number(item.price).toFixed(2) %></td>
                <td class="text-end"><%= item.quantity %></td>
                <td class="text-end">$<%= (Number(item.price) * Number(item.quantity)).toFixed(2) %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <div class="total-row">Total: $<%= Number(total || 0).toFixed(2) %></div>
    </div>

    <div class="card-soft">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label fw-bold">Payment Method</label>
          <select id="paymentMethod" class="form-select">
            <option value="paypal" selected>PayPal</option>
            <option value="nets">NETS QR</option>
            <option value="bank">Bank Transfer (demo)</option>
          </select>
          <div class="subtle mt-2">Choose a method to display the payment option.</div>
        </div>

        <div class="col-md-8">
          <!-- ✅ PayPal (UNCHANGED logic) -->
          <div id="paypalPanel" class="pay-panel">
            <div class="paypal-box">
              <div class="fw-bold mb-1">Pay with PayPal</div>
              <div class="subtle mb-3">Sandbox testing uses your PayPal sandbox buyer account.</div>

              <div id="paypal-button-container"></div>
              <div id="paypalStatus" class="subtle mt-2"></div>
            </div>
          </div>

          <!-- ✅ NETS QR panel -->
          <div id="netsPanel" class="pay-panel" style="display:none;">
            <div class="nets-box">
              <div class="fw-bold mb-1">Pay with NETS QR</div>
              <div class="subtle mb-3">Click the button to generate a NETS QR code for payment.</div>

              <form action="/pay/nets" method="post">
                <!-- ✅ THIS is the important part: send the cart total -->
                <input type="hidden" name="cartTotal" value="<%= Number(total || 0).toFixed(2) %>">
                <button type="submit" class="btn-nets">Generate NETS QR</button>
              </form>
            </div>
          </div>

          <div id="bankPanel" class="pay-panel" style="display:none;">
            <div class="fw-bold mb-1">Bank Transfer (Demo)</div>
            <div class="subtle">This is a placeholder option for your assignment UI.</div>
          </div>
        </div>
      </div>

      <div class="mt-4">
        <a href="/cart" class="btn-back">Back to Cart</a>
      </div>
    </div>
  </div>

  <!-- ✅ IMPORTANT: PayPal SDK stays exactly the same -->
  <script src="https://www.paypal.com/sdk/js?client-id=<%= PAYPAL_CLIENT_ID %>&currency=SGD"></script>

  <script>
    const paymentMethodEl = document.getElementById("paymentMethod");
    const paypalPanel = document.getElementById("paypalPanel");
    const netsPanel = document.getElementById("netsPanel");
    const bankPanel = document.getElementById("bankPanel");
    const paypalStatus = document.getElementById("paypalStatus");

    function switchMethod(){
      const m = paymentMethodEl.value;
      paypalPanel.style.display = (m === "paypal") ? "block" : "none";
      netsPanel.style.display = (m === "nets") ? "block" : "none";
      bankPanel.style.display = (m === "bank") ? "block" : "none";
    }
    paymentMethodEl.addEventListener("change", switchMethod);
    switchMethod();

    // server total
    const total = Number("<%= Number(total || 0).toFixed(2) %>");

    /* ✅ PayPal logic BELOW is UNCHANGED */
    paypal.Buttons({
      createOrder: async function () {
        paypalStatus.textContent = "Creating PayPal order...";
        const res = await fetch("/api/paypal/create-order", {
          method: "POST",
          headers: { "Content-Type": "application/json" }
        });

        const data = await res.json();
        if (!res.ok) {
          paypalStatus.textContent = "";
          throw new Error(data.message || data.error || "Failed to create order");
        }
        return data.id;
      },

      onApprove: async function (data) {
        paypalStatus.textContent = "Capturing payment...";
        const res = await fetch("/api/paypal/capture-order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ orderID: data.orderID })
        });

        const result = await res.json();
        if (!res.ok || result.status !== "COMPLETED") {
          paypalStatus.textContent = "";
          throw new Error(result.message || result.error || "Payment not completed");
        }

        window.location.href = "/paypal/success";
      },

      onError: function (err) {
        console.error(err);
        paypalStatus.textContent = "";
        alert("PayPal error. Please try again.");
      }
    }).render("#paypal-button-container");
  </script>
</body>
</html>
