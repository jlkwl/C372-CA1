<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Your Cart</title>
    <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
    <header>
        <h1>Your Cart</h1>
        <% if (user) { %>
            <p>Welcome, <%= user.name || user.username || 'User' %></p>
        <% } %>
    </header>

    <section class="messages">
        <% if (errors && errors.length) { %>
            <div class="errors">
                <% errors.forEach(function(e){ %>
                    <p class="error"><%= e %></p>
                <% }) %>
            </div>
        <% } %>

        <% if (messages && messages.length) { %>
            <div class="messages-list">
                <% messages.forEach(function(m){ %>
                    <p class="success"><%= m %></p>
                <% }) %>
            </div>
        <% } %>
    </section>

    <section class="cart">
        <% if (!cart || cart.length === 0) { %>
            <p>Your cart is empty.</p>
            <a href="/shopping">Continue shopping</a>
        <% } else { %>
            <form action="/cart/update" method="post">
                <table>
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Product</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Subtotal</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% cart.forEach(function(item){ %>
                            <tr>
                                <td>
                                    <% if (item.image) { %>
                                        <img src="/images/<%= item.image %>" alt="<%= item.productName %>" style="width:80px"/>
                                    <% } %>
                                </td>
                                <td><%= item.productName %></td>
                                <td>$<%= Number(item.price).toFixed(2) %></td>
                                <td>
                                    <input type="number" name="quantity" value="<%= item.quantity %>" min="1" />
                                    <input type="hidden" name="productId" value="<%= item.productId %>"/>
                                </td>
                                <td>$<%= (Number(item.price) * Number(item.quantity)).toFixed(2) %></td>
                                <td>
                                    <form action="/remove-from-cart/<%= item.productId %>" method="post" style="display:inline">
                                        <button type="submit">Remove</button>
                                    </form>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </form>

            <div class="cart-summary">
                <p>
                    Total:
                    $<%= cart.reduce((s,i)=> s + (Number(i.price) * Number(i.quantity)), 0).toFixed(2) %>
                </p>

                <form action="/checkout" method="post" style="display:inline">
                    <button type="submit">Checkout</button>
                </form>

                <form action="/clear-cart" method="post" style="display:inline">
                    <button type="submit">Clear Cart</button>
                </form>

                <a href="/shopping">Continue shopping</a>
            </div>
        <% } %>
    </section>
</body>
</html>
